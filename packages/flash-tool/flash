#!/bin/bash


RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RESET='\033[m'

UPDATE_BIN="macos/update"

# æ£€æŸ¥è¿è¡Œç¯å¢ƒ
if [ "$(uname -s)" != "Darwin" ]; then
   echo "âŒ è¯¥è„šæœ¬åªæ”¯æŒ macOS è¿è¡Œ"
   exit 1
fi

# æ£€æŸ¥ update å·¥å…·æ˜¯å¦å­˜åœ¨
if [ ! -f "$UPDATE_BIN" ]; then
   echo "âŒ æ‰¾ä¸åˆ°åˆ·æœºå·¥å…·: $UPDATE_BIN"
   exit 1
fi

# è¿è¡Œ update å‘½ä»¤
run_update() {
    local cmd="$UPDATE_BIN 2>/dev/null"
    local need_spaces=0
    
    if [[ "$1" == "bulkcmd" ]]; then
       need_spaces=1
    fi
    
    cmd+=" $1"
    shift 1
    
    for arg in "$@"; do
        if [[ $need_spaces == 1 ]]; then
           cmd+=" \"     $arg\""
        else
           cmd+=" $arg"
        fi
    done
    
    echo -e "${CYAN}æ‰§è¡Œ: $cmd${RESET}"
    local result=$(eval "$cmd")
    echo -e "${YELLOW}$result${RESET}"
    
    if echo "$result" | grep -q "ERR"; then
       echo -e "${RED}å‘½ä»¤æ‰§è¡Œå¤±è´¥${RESET}"
       return 1
    fi
    
    return 0
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo ""
    echo "å°çˆ±éŸ³ç®±åˆ·æœºå·¥å…· v1.0.0  by https://del.wang"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  ./flash connect                   # è¿æ¥è®¾å¤‡"
    echo "  ./flash delay <ç§’æ•°>              # è®¾ç½®å¯åŠ¨å»¶æ—¶ï¼Œå¦‚ 5 ç§’"
    echo "  ./flash switch <bootåˆ†åŒº>         # è®¾ç½®å¯åŠ¨åˆ†åŒºï¼Œå¦‚ boot0"
    echo "  ./flash system <åˆ†åŒº> <å›ºä»¶è·¯å¾„>  # æŠŠå›ºä»¶åˆ·åˆ°æŒ‡å®šåˆ†åŒºï¼Œå¦‚ system0"
}

# è¿æ¥è®¾å¤‡
cmd_connect() {
    echo "ğŸ”Œ è¯·å…ˆæ‹”æ‰è®¾å¤‡ç”µæºï¼Œç„¶åé‡æ–°æ’ä¸Šç”µæº"
    echo "ğŸ’¡ å¦‚æœé•¿æ—¶é—´æœªè¿æ¥ï¼Œè¯·æ‹”æ’ç”µæºåé‡è¯•..."
    while true; do
        run_update identify 7
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}âœ… è®¾å¤‡å·²è¿æ¥${RESET}"
            return 0
        fi
        echo "â³ ç­‰å¾…è®¾å¤‡è¿æ¥..."
        sleep 1
    done
}

# è®¾ç½®å¯åŠ¨åˆ†åŒº
cmd_switch() {
    if [ -z "$1" ]; then
        echo "âŒ è¯·æŒ‡å®šå¯åŠ¨åˆ†åŒºåç§°,å¦‚: ./flash switch boot0"
        return 1
    fi
    
    echo "ğŸ“‹ è®¾ç½®å¯åŠ¨åˆ†åŒºä¸º: $1"
    run_update bulkcmd "setenv boot_part $1"
    run_update bulkcmd "saveenv"
    echo -e "${GREEN}âœ… è®¾ç½®æˆåŠŸ${RESET}"
}

# è®¾ç½®å¯åŠ¨å»¶æ—¶
cmd_delay() {
    if [ -z "$1" ]; then
        echo "âŒ è¯·æŒ‡å®šå¯åŠ¨å»¶æ—¶(ç§’),å¦‚: ./flash delay 15"
        return 1
    fi
    
    echo "â±ï¸ è®¾ç½®å¯åŠ¨å»¶æ—¶ä¸º: $1 ç§’"
    run_update bulkcmd "setenv bootdelay $1"
    run_update bulkcmd "saveenv"
    echo -e "${GREEN}âœ… è®¾ç½®æˆåŠŸ${RESET}"
}

# åˆ·å…¥åˆ†åŒº
cmd_system() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "âŒ è¯·æŒ‡å®šåˆ†åŒºåç§°å’Œæ–‡ä»¶,å¦‚: ./flash system system0 root.squashfs"
        return 1
    fi
    
    if [ ! -f "$2" ]; then
        echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $2"
        return 1
    fi
    
    echo "ğŸ’¾ æ­£åœ¨åˆ·å…¥ $2 åˆ° $1 åˆ†åŒº..."
    run_update partition "$1" "$2"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… åˆ·å…¥æˆåŠŸ${RESET}"
    else
        echo -e "${RED}âŒ åˆ·å…¥å¤±è´¥${RESET}"
        return 1
    fi
}

# ä¸»å‘½ä»¤å¤„ç†
case "$1" in
    connect)
        cmd_connect
        ;;
    switch)
        cmd_switch "$2"
        ;;
    delay)
        cmd_delay "$2"
        ;;
    system)
        cmd_system "$2" "$3"
        ;;
    *)
        show_help
        ;;
esac
