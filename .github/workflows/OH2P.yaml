name: Xiaomi æ™ºèƒ½éŸ³ç®± Proï¼ˆOH2Pï¼‰
on:
  workflow_dispatch:

jobs:
  build:
    name: Xiaomi æ™ºèƒ½éŸ³ç®± Pro å›ºä»¶æ›´æ–°
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ğŸš— åˆå§‹åŒ– Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"
      - name: ğŸ”¥ æ„å»ºå›ºä»¶
        id: build
        env:
          MI_USER: ${{ secrets.MI_USER }}
          MI_PASSWORD: ${{ secrets.MI_PASS }}
          MI_DEVICE: Xiaomi æ™ºèƒ½éŸ³ç®± Pro
          SSH_PASSWORD: open-xiaoai
        run: |
          cd packages/client-patch
          npm install
          npm run build
          MODEL=$(cat assets/.model)
          VERSION=$(cat assets/.version)
          TAG=${MODEL}_${VERSION}
          FIRMWARE=$(basename $(ls \assets/*.bin 2>/dev/null | head -n 1) .bin)
          cp assets/$FIRMWARE/root.squashfs assets/${TAG}.squashfs
          cp assets/$FIRMWARE/root-patched.squashfs assets/${TAG}_patched.squashfs
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      - name: âœ… å‘å¸ƒå›ºä»¶
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Xiaomi æ™ºèƒ½éŸ³ç®± Pro v${{ steps.build.outputs.version }}
          tag: ${{ steps.build.outputs.tag }}
          body: Xiaomi æ™ºèƒ½éŸ³ç®± Pro v${{ steps.build.outputs.version }} å›ºä»¶æ›´æ–°
          draft: true
          prerelease: false
          makeLatest: latest
          removeArtifacts: true
          artifacts: packages/client-patch/assets/*.squashfs